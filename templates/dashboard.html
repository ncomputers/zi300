<!-- Purpose: dashboard template -->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Z-Eye System Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', path='css/site.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    {% if cfg.enable_live_charts %}
    <script defer src="{{ url_for('static', path='js/chart.umd.min.js') }}"></script>
    {% endif %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body{padding-top:70px;}
        .trend-chart{height:30px!important;margin-top:.4rem;}
        .feed-img{max-height:120px;object-fit:cover;}
        footer{background:var(--card-bg);font-size:.9rem;}
        .dark-mode footer{background:#111;color:#fff;}
    </style>
</head>
<body>
<!-- ===== Section: Navbar ===== -->
{% include 'partials/header.html' %}
{% if error_message %}
<div class="alert alert-danger text-center">{{ error_message }}</div>
{% endif %}
<!-- ===== Section: Main Content ===== -->
<!-- ===== Section: Polling Status ===== -->
<div id="pollStatus" class="text-center text-danger small"></div>
<div class="d-flex justify-content-end me-3 gap-2">
    <button id="viewToggle" class="btn btn-sm btn-outline-secondary">Graph View</button>
    <button id="mapToggle" class="btn btn-sm btn-outline-secondary">Map View</button>
    <a href="/troubleshooter" class="btn btn-sm btn-outline-secondary">Troubleshooter</a>
    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#alertsPanel" aria-controls="alertsPanel">
        Alerts <span id="unreadBadge" class="badge bg-danger ms-1" style="display:none;">0</span>
    </button>

</div>
<div class="offcanvas offcanvas-end" tabindex="-1" id="alertsPanel" aria-labelledby="alertsLabel">
    <div class="offcanvas-header">
        <h5 id="alertsLabel" class="offcanvas-title">Alerts</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div id="alertsList"></div>
    </div>
</div>
<div id="cardView" class="container-fluid text-center mt-3">
    <!-- ===== Section: Person KPIs ===== -->
    {% if 'person' in cfg.track_objects %}
    <div class="stats-grid mb-3" data-widget="person">
        <div id="box-current" class="stat-box gradient-green text-center" data-aos="fade-up">
            <i class="fa-solid fa-users fa-2x"></i>
            <div class="stat-title">People Inside</div>
            <div class="stat-number" id="current_count">{{group_counts.get('person', {}).get('current', 0)}}</div>
            <div class="stat-trend" id="current_trend"></div>
            <canvas id="current_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
            <div id="status_msg" class="stat-label fw-bold">{{status}}</div>
        </div>
        <div class="stat-box gradient-blue text-center" data-aos="fade-up">
            <i class="fa-solid fa-person-walking-arrow-right fa-2x"></i>
            <div class="stat-title">People Entered</div>
            <div class="stat-number" id="in_count">{{group_counts.get('person', {}).get('in', 0)}}</div>
            <div class="stat-trend" id="in_trend"></div>
            <canvas id="in_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
        <div class="stat-box gradient-red text-center" data-aos="fade-up">
            <i class="fa-solid fa-person-walking-arrow-right fa-2x fa-flip-horizontal"></i>
            <div class="stat-title">People Exited</div>
            <div class="stat-number" id="out_count">{{group_counts.get('person', {}).get('out', 0)}}</div>
            <div class="stat-trend" id="out_trend"></div>
            <canvas id="out_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
    </div>
    {% endif %}
    <!-- ===== Section: Vehicle KPIs ===== -->
    {% if 'vehicle' in cfg.track_objects %}
    <div class="stats-grid mb-3" data-widget="vehicle">
        <div class="stat-box gradient-green text-center" data-aos="fade-up">
            <i class="fa-solid fa-car fa-2x"></i>
            <div class="stat-title">Vehicles Inside</div>
            <div class="stat-number" id="vehicle_current">{{group_counts.get('vehicle', {}).get('current',0)}}</div>
            <div class="stat-trend" id="vehicle_current_trend"></div>
            <canvas id="vehicle_current_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
        <div class="stat-box gradient-blue text-center" data-aos="fade-up">
            <i class="fa-solid fa-arrow-right fa-2x"></i>
            <div class="stat-title">Vehicles Entered</div>
            <div class="stat-number" id="vehicle_in">{{group_counts.get('vehicle', {}).get('in',0)}}</div>
            <div class="stat-trend" id="vehicle_in_trend"></div>
            <canvas id="vehicle_in_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
        <div class="stat-box gradient-red text-center" data-aos="fade-up">
            <i class="fa-solid fa-arrow-left fa-2x"></i>
            <div class="stat-title">Vehicles Exited</div>
            <div class="stat-number" id="vehicle_out">{{group_counts.get('vehicle', {}).get('out',0)}}</div>
            <div class="stat-trend" id="vehicle_out_trend"></div>
            <canvas id="vehicle_out_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
    </div>
    {% endif %}
    <!-- ===== Section: PPE Anomaly KPIs ===== -->
    <div class="stats-grid mb-4" data-widget="anomaly">
        {% set colors = {} %}
        {% for item in alert_items %}
            {% set _ = colors.update({item: 'gradient-warning'}) %}
        {% endfor %}
        {% do colors.update({
            'no_helmet':'gradient-red',
            'no_safety_shoes':'gradient-blue',
            'no_safety_glasses':'gradient-info',
            'no_protective_gloves':'gradient-warning',
            'no_dust_mask':'gradient-secondary',
            'no_face_shield':'gradient-dark',
            'no_vest_jacket':'gradient-green',
        }) %}
        {% set icons = {} %}
        {% for item in alert_items %}
            {% set _ = icons.update({item: 'fa-circle-exclamation'}) %}
        {% endfor %}
        {% do icons.update({
            'no_helmet':'fa-hard-hat',
            'no_safety_shoes':'fa-shoe-prints',
            'no_safety_glasses':'fa-glasses',
            'no_protective_gloves':'fa-hand-paper',
            'no_dust_mask':'fa-head-side-mask',
            'no_face_shield':'fa-user-shield',
            'no_vest_jacket':'fa-tshirt'
        }) %}
        {% for item in cfg.alert_anomalies %}
        {% if item.startswith('no_') %}
        <div class="stat-box {{ colors.get(item,'gradient-warning') }} text-center" id="box-{{item}}" data-aos="fade-up" style="cursor:pointer">
            <i class="fa-solid {{ icons.get(item,'fa-circle-exclamation') }} fa-2x"></i>
            <div class="stat-title">{{item.replace('no_','No ').replace('_',' ')}}</div>
            <div class="stat-number" id="{{item}}_count">{{anomaly_counts[item]}}</div>
            <div class="stat-trend" id="{{item}}_trend"></div>
            <canvas id="{{item}}_chart" class="trend-chart{% if not cfg.enable_live_charts %} d-none{% endif %}"></canvas>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    <!-- ===== Section: Camera Feeds ===== -->
    <div class="row mb-4" data-widget="feeds">
        <div class="col-md-8">
            <div class="row" id="feeds">
            {% for cam in cameras if not cam.archived %}
                <div class="col-md-6 mb-3" data-aos="fade-up">
                    <div class="card">
                      <div class="card-header">
                        {{cam.name}}
                      </div>
                      <div class="feed-container">
                        <img class="card-img-top feed-img" data-cam="{{ cam.id }}" src="{{ url_for('camera_mjpeg', camera_id=cam.id) }}" alt="feed">

                      </div>

                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
        <div class="col-md-4">
            <div class="table-responsive">
                <canvas id="occChart" class="w-100{% if not cfg.enable_live_charts %} d-none{% endif %}" style="height:240px;"></canvas>
            </div>
            <div class="table-responsive mt-4">
                <canvas id="liveChart" class="w-100{% if not cfg.enable_live_charts %} d-none{% endif %}" style="height:240px;"></canvas>
            </div>
        </div>
    </div>
     {% for status in cfg.preview_anomalies %}
     <div class="row mb-4">
         <h5>Latest {{ status.replace('no_','No ').replace('_',' ') }}</h5>
         <div id="previewImgs-{{ status }}" class="d-flex flex-wrap"></div>
     </div>
     {% endfor %}
</div>
<div id="graphView" class="container-fluid mt-3" style="display:none;">
    <div class="stats-grid mb-3">
        <div class="stat-box gradient-blue text-center" data-aos="fade-up">
            <i class="fa-solid fa-users fa-2x"></i>
            <div class="stat-title">Total Visitors</div>
            <div class="stat-number" id="kpi_total_visitors">0</div>
            <div class="stat-trend" id="kpi_total_visitors_trend"></div>
            <canvas id="kpi_total_visitors_chart" class="trend-chart" style="display:none"></canvas>
        </div>
        <div class="stat-box gradient-green text-center" data-aos="fade-up">
            <i class="fa-solid fa-building-user fa-2x"></i>
            <div class="stat-title">Current Occupancy</div>
            <div class="stat-number" id="kpi_current_occupancy">0</div>
            <div class="stat-trend" id="kpi_current_occupancy_trend"></div>
            <canvas id="kpi_current_occupancy_chart" class="trend-chart" style="display:none"></canvas>
        </div>
        <div class="stat-box gradient-info text-center" data-aos="fade-up">
            <i class="fa-solid fa-car-side fa-2x"></i>
            <div class="stat-title">Vehicles Detected</div>
            <div class="stat-number" id="kpi_vehicles_detected">0</div>
            <div class="stat-trend" id="kpi_vehicles_detected_trend"></div>
            <canvas id="kpi_vehicles_detected_chart" class="trend-chart" style="display:none"></canvas>
        </div>
        <div class="stat-box gradient-red text-center" data-aos="fade-up">
            <i class="fa-solid fa-triangle-exclamation fa-2x"></i>
            <div class="stat-title">Safety Violations</div>
            <div class="stat-number" id="kpi_safety_violations">0</div>
            <div class="stat-trend" id="kpi_safety_violations_trend"></div>
            <canvas id="kpi_safety_violations_chart" class="trend-chart" style="display:none"></canvas>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Timeframe</label>
        <select id="timeframe" class="form-select w-auto d-inline-block ms-2" aria-label="Timeframe">
            <option value="today">Today</option>
            <option value="7d" selected>Last 7 Days</option>
            <option value="this_month">This Month</option>
        </select>
        <div class="form-check form-switch d-inline-block ms-3">
            <input class="form-check-input" type="checkbox" id="comparisonToggle">
            <label class="form-check-label" for="comparisonToggle">Compare</label>

        </div>
    </div>
    <div id="graphError" class="text-danger text-center mb-2"></div>
    <div class="row g-4 text-center">
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-header bg-transparent border-bottom-0">People Inside</div>
                <div class="card-body">
                    <div class="table-responsive"><canvas id="peopleInsideDonut"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-header bg-transparent border-bottom-0">People Flow</div>
                <div class="card-body">
                    <div class="table-responsive"><canvas id="peopleBar"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-header bg-transparent border-bottom-0">Vehicle Trend</div>
                <div class="card-body">
                    <div class="table-responsive"><canvas id="vehicleLine"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-header bg-transparent border-bottom-0">PPE Alerts</div>
                <div class="card-body">
                    <div class="table-responsive"><canvas id="ppeDonut"></canvas></div>
                </div>
            </div>
        </div>
        {% if cameras %}
        {% set cam = cameras[0] %}
        <div class="col-md-2">
            <img class="img-fluid feed-img" data-cam="{{ cam.id }}" src="{{ url_for('camera_mjpeg', camera_id=cam.id) }}" alt="feed">
        </div>
        {% endif %}

    </div>
</div>
<div id="mapView" class="container-fluid mt-3" style="display:none;">
    <div id="cameraMap" style="height:500px;"></div>
</div>
<div class="toast-container position-fixed top-0 end-0 p-3" id="alertToasts"></div>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="{{ url_for('static', path='js/dashboard_map.js') }}"></script>
<script src="{{ url_for('static', path='js/mjpeg_feed.js') }}"></script>
{% set ppe_keys = [] %}
{% for item in cfg.alert_anomalies %}
  {% if item.startswith('no_') %}
    {% do ppe_keys.append(item) %}
  {% endif %}
{% endfor %}
<script id="dashboard-config" type="application/json">
{{ {
  'enableCharts': cfg.enable_live_charts,
  'updateFreq': cfg.chart_update_freq,
  'previewAnomalies': cfg.preview_anomalies,
  'maxCap': max_capacity,
  'ppeStatuses': ppe_keys
} | tojson }}
</script>
<script type="module">
import { animateMetric, updateTrend } from "{{ url_for('static', path='js/stats_utils.js') }}";
function applyWidgetPrefs(){
  const prefs=JSON.parse(localStorage.getItem('dashboardWidgets')||'{}');
  document.querySelectorAll('[data-widget]').forEach(el=>{
    const k=el.dataset.widget;
    el.style.display=prefs[k]===false?'none':'';
  });
  document.querySelectorAll('.widget-setting').forEach(cb=>{
    const k=cb.dataset.widget;
    cb.checked=prefs[k]!==false;
  });
}
async function loadWidgetPrefs(){
  try{
    const r=await fetch('/api/profile/widgets');
    if(r.ok){
      const d=await r.json();
      if(d.widgets) localStorage.setItem('dashboardWidgets',JSON.stringify(d.widgets));
    }
  }catch(e){console.error('load prefs',e);}
  applyWidgetPrefs();
}
async function saveWidgetPrefs(){
  const prefs={};
  document.querySelectorAll('.widget-setting').forEach(cb=>{prefs[cb.dataset.widget]=cb.checked;});
  localStorage.setItem('dashboardWidgets',JSON.stringify(prefs));
  try{
    await fetch('/api/profile/widgets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(prefs)});
  }catch(e){console.error('save prefs',e);}
  applyWidgetPrefs();
  if(window.dashboardGraph&&window.dashboardGraph.load) window.dashboardGraph.load();
}

window.addEventListener('DOMContentLoaded',async()=>{
  const cfgData=JSON.parse(document.getElementById('dashboard-config').textContent);
  const enableCharts=cfgData.enableCharts;
  const updateFreq=cfgData.updateFreq;
  const previewAnomalies=cfgData.previewAnomalies;
  let maxCap=cfgData.maxCap;
  const ppeStatuses=cfgData.ppeStatuses;
  AOS.init();
  await loadWidgetPrefs();
  const statusEl=document.getElementById('pollStatus');
let poller=null;
const cardView=document.getElementById('cardView');
const graphView=document.getElementById('graphView');
const toggleBtn=document.getElementById('viewToggle');
const mapView=document.getElementById('mapView');
const mapBtn=document.getElementById('mapToggle');
const alertsBtn=document.querySelector('[data-bs-toggle="offcanvas"][data-bs-target="#alertsPanel"]');
const unreadBadge=document.getElementById('unreadBadge');
const saveBtn=document.getElementById('saveWidgetPrefs');
if(saveBtn) saveBtn.addEventListener('click',saveWidgetPrefs);

const feeds=document.querySelectorAll('img.feed-img');
feeds.forEach(img=>{
  const err=document.createElement('div');
  err.className='text-danger small text-center feed-error';
  err.textContent='Stream unavailable';
  err.style.display='none';
  img.after(err);
  img.addEventListener('error',()=>{
    console.error('Stream failed for camera', img.dataset.cam);
    img.style.display='none';
    err.style.display='block';
  });
  img.addEventListener('load',()=>{
    err.style.display='none';
    img.style.display='';
  });
});
let graphInit=false;
async function ensureChartJs(){
  if(window.Chart) return;
  await new Promise(res=>{
    const s=document.createElement('script');
    s.src="{{ url_for('static', path='js/chart.umd.min.js') }}";
    s.onload=res;
    document.head.appendChild(s);
  });
}
async function initGraphView(){
  if(graphInit) return;
  await ensureChartJs();
  initGraphCharts(maxCap);
  graphInit=true;
  if(window.dashboardGraph&&window.dashboardGraph.load){
    window.dashboardGraph.load();
  }
}
function resizeCharts(){
  [donutChart,peopleBarChart,vehicleLineChart,ppeChart].forEach(c=>{
    if(c&&typeof c.resize==='function') c.resize();
  });
}
function applyView(){
  const view=localStorage.getItem('dashboardView')||'card';
  if(view==='graph'){
    cardView.style.display='none';
    graphView.style.display='block';
    mapView.style.display='none';
    toggleBtn.style.display='';
    mapBtn.textContent='Map View';
    toggleBtn.textContent='Card View';
    if(graphInit){
      if(window.dashboardGraph&&window.dashboardGraph.load){
        window.dashboardGraph.load();
      }
      resizeCharts();
    }else{
      initGraphView().then(()=>{resizeCharts();});
    }
  }else if(view==='map'){
    cardView.style.display='none';
    graphView.style.display='none';
    mapView.style.display='block';
    toggleBtn.style.display='none';
    mapBtn.textContent='Card View';
    if(window.cameraMapInit) window.cameraMapInit();
  }else{
    graphView.style.display='none';
    mapView.style.display='none';
    cardView.style.display='block';
    toggleBtn.style.display='';
    toggleBtn.textContent='Graph View';
    mapBtn.textContent='Map View';
  }
}
toggleBtn.addEventListener('click',()=>{
  const view=localStorage.getItem('dashboardView')==='graph'?'card':'graph';
  localStorage.setItem('dashboardView',view);
  applyView();
});
mapBtn.addEventListener('click',()=>{
  const view=localStorage.getItem('dashboardView')==='map'?'card':'map';
  localStorage.setItem('dashboardView',view);
  applyView();
});
applyView();
function startPolling(){
    if(poller) return;
    statusEl.textContent='Polling for updates...';
    poller=setInterval(async()=>{
      try{
        const r=await fetch('/api/stats');
        if(r.ok){
          const d=await r.json();
          handleData(d);
          statusEl.textContent='';
        }else{
          statusEl.textContent=`Error ${r.status}`;
        }
      }catch(e){
        console.error('Failed to fetch stats',e);
        statusEl.textContent='Failed to fetch stats';
      }
    },2000);
  }
  startPolling();
async function loadAlerts(){
  try{
    const r=await fetch('/api/alerts/recent');
    if(!r.ok) return;
    const alerts=await r.json();
    const list=document.getElementById('alertsList');
    if(list) list.innerHTML=alerts.map(a=>`<div>${a.message||a}</div>`).join('')||'<div class="text-muted">No alerts</div>';
    if(unreadBadge){
      if(alerts.length){
        unreadBadge.textContent=alerts.length;
        unreadBadge.style.display='';
      }else{
        unreadBadge.style.display='none';
      }
    }
  }catch(e){
    console.error('Failed to load alerts',e);
  }
}
if(alertsBtn){
  alertsBtn.addEventListener('click',async()=>{
    await loadAlerts();
    if(unreadBadge) unreadBadge.style.display='none';
  });
}
loadAlerts();
let chart;
let liveChart;
let donutChart,peopleBarChart,vehicleLineChart,ppeChart;
const sparkCharts={};
const ppeColors=['#e74c3c','#c0392b','#d35400','#e67e22','#f1c40f','#3498db','#9b59b6','#1abc9c','#2ecc71','#34495e'];
function hexToRgba(hex,alpha){
  const bigint=parseInt(hex.slice(1),16);
  const r=(bigint>>16)&255,g=(bigint>>8)&255,b=bigint&255;
  return `rgba(${r},${g},${b},${alpha})`;
}
let labelFn=t=>new Date(t*1000).toLocaleString();
function makeSpark(id,color){
  const el=document.getElementById(id);
  if(!el) return null;
  return new Chart(el.getContext('2d'),{
    type:'line',
    data:{labels:[],datasets:[{data:[],borderColor:color,tension:0.3,fill:false}]},
    options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}},elements:{point:{radius:0}}}
  });
}
function initChart(maxCap){
  const ctx=document.getElementById('occChart').getContext('2d');
  chart=new Chart(ctx,{type:'bar',data:{labels:['Inside','Remaining'],datasets:[{label:'People',data:[0,maxCap],backgroundColor:['#0d6efd','#adb5bd']} ]},options:{indexAxis:'y',scales:{x:{beginAtZero:true,max:maxCap}}}});
}
function initLive(){
  const ctx=document.getElementById('liveChart').getContext('2d');
  liveChart=new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[
      {label:'In',yAxisID:'y1',data:[],borderColor:'green',tension:0.2},
      {label:'Out',yAxisID:'y1',data:[],borderColor:'red',tension:0.2},
      {label:'Currently Inside',yAxisID:'y2',data:[],borderColor:'blue',tension:0.2}
    ]},
    options:{scales:{y1:{type:'linear',position:'left'},y2:{type:'linear',position:'right',grid:{drawOnChartArea:false}}}}
  });
}
function initGraphCharts(maxCap){
  const style=getComputedStyle(document.body);
  const textColor=style.getPropertyValue('--text-color').trim();
  const bgColor=style.getPropertyValue('--card-bg').trim();
  const tooltipOpts={
    backgroundColor:bgColor,
    titleColor:textColor,
    bodyColor:textColor,
    callbacks:{
      title(items){
        const chart=items[0].chart;
        const idx=items[0].dataIndex;
        if(chart.data.labelsRaw){
          return labelFn(chart.data.labelsRaw[idx]);
        }
        return items[0].label;
      },
      label(context){
        const val=context.parsed.y!==undefined?context.parsed.y:context.parsed;
        return `${context.dataset.label}: ${val}`;
      }
    }
  };
  const dctx=document.getElementById('peopleInsideDonut');
  if(dctx) donutChart=new Chart(dctx,{type:'doughnut',data:{labels:['Inside','Remaining'],datasets:[{data:[0,maxCap],backgroundColor:['#2ecc71','#ecf0f1']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:tooltipOpts},cutout:'70%'}});
  const bctx=document.getElementById('peopleBar');
  if(bctx) peopleBarChart=new Chart(bctx,{type:'bar',data:{labels:[],datasets:[{label:'Entered',backgroundColor:'#27ae60',data:[]},{label:'Exited',backgroundColor:'#c0392b',data:[]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:tooltipOpts},scales:{y:{beginAtZero:true}}}});
  const vctx=document.getElementById('vehicleLine');
  if(vctx) vehicleLineChart=new Chart(vctx,{type:'line',data:{labels:[],datasets:[{label:'Vehicles',borderColor:'#2980b9',data:[],tension:0.3,fill:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{tooltip:tooltipOpts},scales:{y:{beginAtZero:true}}}});
  const pctx=document.getElementById('ppeDonut');
  if(pctx){
    const labels=ppeStatuses.map(s=>s.replace('no_','No ').replace(/_/g,' '));
    const colors=ppeColors.slice(0,labels.length);
    ppeChart=new Chart(pctx,{type:'doughnut',data:{labels,datasets:[{data:new Array(labels.length).fill(0),backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:tooltipOpts},cutout:'70%'}});
  }

}
if(window.theme && window.theme.onChange){
  window.theme.onChange(()=>{
    if(graphInit){
      initGraphCharts(maxCap);
      if(window.dashboardGraph&&window.dashboardGraph.load){
        window.dashboardGraph.load();
      }
    }
  });
}
if(enableCharts){
  initChart(maxCap);
  initLive();
}
function initSparklines(){
  sparkCharts.in_count=makeSpark('in_chart','green');
  sparkCharts.out_count=makeSpark('out_chart','red');
  sparkCharts.current_count=makeSpark('current_chart','blue');
  sparkCharts.vehicle_current=makeSpark('vehicle_current_chart','blue');
  sparkCharts.vehicle_in=makeSpark('vehicle_in_chart','green');
  sparkCharts.vehicle_out=makeSpark('vehicle_out_chart','red');
  ppeStatuses.forEach(status=>{
    sparkCharts[`${status}_count`]=makeSpark(`${status}_chart`,'white');
  });
}
if(enableCharts){
  initSparklines();
}
window.addEventListener('resize',resizeCharts);

function updateGraphCharts(d,timeframe,prev){
  if(donutChart){

    donutChart.data.datasets[0].data=[d.current,d.max_capacity-d.current];
    if(prev){
      if(donutChart.data.datasets.length<2){
        donutChart.data.datasets.push({data:[0,0],backgroundColor:['#95a5a6','#ecf0f1']});
      }
      donutChart.data.datasets[1].data=[prev.current,prev.max_capacity-prev.current];
    }else if(donutChart.data.datasets.length>1){
      donutChart.data.datasets.splice(1);
    }
    donutChart.update();
  }
  labelFn=timeframe==='today'
    ?(t=>new Date(t*1000).toLocaleTimeString())
    :(timeframe==='7d'||timeframe==='this_month'
       ?(t=>new Date(t*1000).toLocaleDateString())
       :(t=>new Date(t*1000).toLocaleString()));
  if(peopleBarChart){
    peopleBarChart.data.labelsRaw=d.timeline;

    const labels=d.timeline.map(labelFn);
    peopleBarChart.data.labels=labels;
    peopleBarChart.data.datasets[0].data=d.in_counts||[];
    peopleBarChart.data.datasets[1].data=d.out_counts||[];
    if(prev){
      if(peopleBarChart.data.datasets.length<4){
        peopleBarChart.data.datasets.push({label:'Prev Entered',backgroundColor:'rgba(39,174,96,0.5)',data:[]});
        peopleBarChart.data.datasets.push({label:'Prev Exited',backgroundColor:'rgba(192,57,43,0.5)',data:[]});
      }
      peopleBarChart.data.datasets[2].data=prev.in_counts||[];
      peopleBarChart.data.datasets[3].data=prev.out_counts||[];
    }else if(peopleBarChart.data.datasets.length>2){
      peopleBarChart.data.datasets.splice(2);
    }
    peopleBarChart.update();
  }
  if(vehicleLineChart){
    vehicleLineChart.data.labelsRaw=d.timeline;

    const vlabels=d.timeline.map(labelFn);
    vehicleLineChart.data.labels=vlabels;
    vehicleLineChart.data.datasets[0].data=d.vehicle_counts||[];
    if(prev){
      if(vehicleLineChart.data.datasets.length<2){
        vehicleLineChart.data.datasets.push({label:'Prev Vehicles',borderColor:'#95a5a6',data:[],tension:0.3,fill:false,borderDash:[5,5]});
      }
      vehicleLineChart.data.datasets[1].data=prev.vehicle_counts||[];
    }else if(vehicleLineChart.data.datasets.length>1){
      vehicleLineChart.data.datasets.splice(1);
    }
    vehicleLineChart.update();
  }
  if(ppeChart){
    if(d.anomaly_counts){
      ppeChart.data.datasets[0].data=ppeStatuses.map(k=>d.anomaly_counts[k]||0);
    }
    if(prev&&prev.anomaly_counts){
      if(ppeChart.data.datasets.length<2){
        ppeChart.data.datasets.push({data:new Array(ppeStatuses.length).fill(0),backgroundColor:ppeColors.slice(0,ppeStatuses.length).map(c=>hexToRgba(c,0.5))});
      }
      ppeChart.data.datasets[1].data=ppeStatuses.map(k=>prev.anomaly_counts[k]||0);
    }else if(ppeChart.data.datasets.length>1){
      ppeChart.data.datasets.splice(1);
    }

    ppeChart.update();
  }
}
window.updateGraphCharts=updateGraphCharts;
function updateSpark(key,val){
  const c=sparkCharts[key];
  if(!c) return;
  c.data.labels.push('');
  c.data.datasets[0].data.push(val);
  if(c.data.labels.length>20){
    c.data.labels.shift();
    c.data.datasets[0].data.shift();
  }
  c.update('none');
}


function handleData(d){
  animateMetric('in_count',d.in_count);
  updateSpark('in_count',d.in_count);
  animateMetric('out_count',d.out_count);
  updateSpark('out_count',d.out_count);
  animateMetric('current_count',d.current);
  updateSpark('current_count',d.current);
  if(d.group_counts && d.group_counts.vehicle){
    const gv=d.group_counts.vehicle;
    const vin=document.getElementById('vehicle_in');
    if(vin) animateMetric('vehicle_in',gv.in);
    updateSpark('vehicle_in',gv.in);
    const vout=document.getElementById('vehicle_out');
    if(vout) animateMetric('vehicle_out',gv.out);
    updateSpark('vehicle_out',gv.out);
    const vc=document.getElementById('vehicle_current');
    if(vc) animateMetric('vehicle_current',gv.current);
    updateSpark('vehicle_current',gv.current);
  }
  if(d.anomaly_counts){
    for(const [k,v] of Object.entries(d.anomaly_counts)){
      const el=document.getElementById(`${k}_count`);
      if(el) animateMetric(`${k}_count`,v);
      updateSpark(`${k}_count`,v);
    }
  }
  const box=document.getElementById('box-current');
  const msg=document.getElementById('status_msg');
  if(box&&msg){
    box.classList.remove('gradient-green','gradient-warning','gradient-red');
    if(d.status==='green'){box.classList.add('gradient-green');msg.textContent='Safe';}
    else if(d.status==='yellow'){box.classList.add('gradient-warning');msg.textContent='Warning';}
    else{box.classList.add('gradient-red');msg.textContent='Full';}
  }
  if(d.trends){
    Object.entries(d.trends).forEach(([k,v])=>updateTrend(k,v));
  }
  if(enableCharts){
    chart.options.scales.x.max=d.max_capacity;
    chart.data.datasets[0].data=[d.current,d.max_capacity-d.current];
    chart.update();

    const now=new Date().toLocaleTimeString();
    liveChart.data.labels.push(now);
    liveChart.data.datasets[0].data.push(d.in_count);
    liveChart.data.datasets[1].data.push(d.out_count);
    liveChart.data.datasets[2].data.push(d.current);
    if(liveChart.data.labels.length>30){
      liveChart.data.labels.shift();
      liveChart.data.datasets.forEach(ds=>ds.data.shift());
    }
    liveChart.update();

  }
}
document.querySelectorAll('[id^="box-no_"]').forEach(box=>{
  box.addEventListener('click',()=>{location.href=`/ppe_report?status=${box.id.replace('box-','')}`;});
});
async function loadPreview(){
  for(const status of previewAnomalies){
    const box=document.getElementById(`previewImgs-${status}`);
    if(!box) continue;
    try{
      const r=await fetch(`/latest_images?status=${status}`);
      if(!r.ok) continue;
      const d=await r.json();
      box.innerHTML='';
      d.images.forEach(u=>{
        const i=document.createElement('img');
        i.src=u;
        i.width=80;
        i.className='me-2 mb-2';
        box.appendChild(i);
      });
    }catch(e){
      console.error('preview',status,e);
    }
  }
}
setInterval(loadPreview,updateFreq*1000);
loadPreview();
});
</script>
<script src="{{ url_for('static', path='js/dashboard_graph.js') }}"></script>
{% include 'partials/footer.html' %}
</body>
</html>
