<!-- htmlhint spec-char-escape:false, tag-pair:false -->
<!-- Purpose: email alerts template -->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Alert Rules</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', path='css/site.css') }}">
</head>
<body class="vms-body">
<!-- ===== Section: Navbar ===== -->
{% include 'partials/header.html' %}
<!-- ===== Section: Main Content ===== -->
<div class="container mt-4">
    <h1 class="mb-4">Email &amp; Alerts</h1>
    <p><a href="/docs/alerts">Alert rules documentation</a></p>
    <div id="msg"></div>
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary" id="toggleMetrics" type="button">Show Today's Metrics</button>
    </div>
    <div id="miniMetrics" class="row g-2 mb-3 d-none">
        <div class="col-auto"><small>New Entries: <span id="metric_person_in">0</span></small></div>
        <div class="col-auto"><small>Exits: <span id="metric_person_out">0</span></small></div>
        <div class="col-auto"><small>Vehicles In: <span id="metric_vehicle_in">0</span></small></div>
        <div class="col-auto"><small>Vehicles Out: <span id="metric_vehicle_out">0</span></small></div>
        <div class="col-auto"><small>Vehicles Detected: <span id="metric_vehicle_detected">0</span></small></div>
    </div>
    <form id="rulesForm">
    <div class="table-responsive">
    <table class="table" id="rulesTable">
        <thead>
        <tr><th>Metric</th><th>Type</th><th>Value</th><th>Window</th><th>Recipients</th><th>Attach</th><th></th></tr>
        </thead>
        <tbody>
        {% for r in rules %}
        <tr>
            <td>
                <select class="form-select metric">
                {% for opt in anomaly_items %}
                    <option value="{{opt}}"{% if r.metric == opt %} selected="selected"{% endif %}>{{opt.replace('_',' ').title()}}</option>
                {% endfor %}
                </select>
            </td>
            <td>
                <select class="form-select type">
                    <option value="event"{% if r.type == "event" %} selected="selected"{% endif %}>Event</option>
                    <option value="threshold"{% if r.type == "threshold" %} selected="selected"{% endif %}>Threshold</option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control value" value="{{r.value or 1}}" min="1">
                <div class="form-text">Count threshold</div>
            </td>
            <td>
                <select class="form-select window{% if r.type != 'threshold' %} d-none{% endif %}">
                    <option value="1"{% if r.window == 1 %} selected{% endif %}>1 min</option>
                    <option value="5"{% if r.window == 5 %} selected{% endif %}>5 min</option>
                    <option value="15"{% if r.window == 15 %} selected{% endif %}>15 min</option>
                    <option value="60"{% if r.window == 60 %} selected{% endif %}>60 min</option>
                </select>
            </td>
            <td><input class="form-control recipients" value="{{r.recipients}}"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input attach" {% if r.attach %}checked{% endif %}></td>
            <td><button class="btn btn-danger btn-sm del" type="button">Delete</button></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
    <input type="hidden" name="csrf_token" value="{{csrf_token}}">
    <button class="btn btn-secondary mb-3" id="addRule" type="button">Add Rule</button>
    <div>
        <button class="btn btn-primary" id="save" type="button">Save</button>
        <a href="/" class="btn btn-outline-secondary ms-2">Back</a>
    </div>
    </form>
</div>
<template id="metricOptionsTemplate">
{% for opt in anomaly_items %}
<option value="{{opt}}">{{opt.replace('_',' ').title()}}</option>
{% endfor %}
</template>
<script src="{{ url_for('static', path='js/email_alerts.js') }}"></script>
<script src="{{ url_for('static', path='js/alert_stats.js') }}"></script>
{% include 'partials/footer.html' %}
</body>
</html>
