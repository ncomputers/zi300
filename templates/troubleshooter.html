<!-- Purpose: troubleshooter template -->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Troubleshooter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/flatly/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
    #eventsPanel{position:fixed;top:0;right:0;width:300px;height:100%;overflow-y:auto;border-left:1px solid #ccc;background:#f8f9fa;padding:.5rem;}
    .event-chip{display:block;margin-bottom:4px;}
    body{margin-right:320px;}
    </style>
</head>
<body>
{% include 'partials/header.html' %}
<div class="container mt-4">
    <h1 class="mb-4">Troubleshooter</h1>
    <div class="table-responsive">
        <table class="table table-bordered align-middle">
            <thead><tr><th>Camera</th><th>Preview</th><th>Action</th><th>Results</th></tr></thead>
            <tbody>
            {% for cam in cameras %}
            <tr data-id="{{ cam.id }}">
                <td>{{ cam.name }}</td>
                <td><img class="img-fluid feed-img" data-cam="{{ cam.id }}"/></td>
                <td><button class="btn btn-sm btn-outline-primary run-btn">Run diagnostics</button></td>
                <td><ul class="list-unstyled results small mb-0"></ul></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div id="eventsPanel">
  <h5>Recent Events</h5>
  <select id="eventFilter" class="form-select form-select-sm mb-2">
    <option value="">All Events</option>
  </select>
  <select id="camFilter" class="form-select form-select-sm mb-2">
    <option value="">All Cameras</option>
  </select>
  <div id="eventsList"></div>
</div>
<script>
document.querySelectorAll('.run-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
        const tr = btn.closest('tr');
        const camId = tr.dataset.id;
        const ul = tr.querySelector('.results');
        ul.innerHTML = '<li><span class="badge bg-secondary">running</span></li>';
        try{
            const res = await fetch(`/api/troubleshooter/${camId}`);
            const data = await res.json();
            ul.innerHTML = '';
            data.forEach(r=>{
                const li = document.createElement('li');
                const badge = document.createElement('span');
                let cls, txt;
                if(r.ok === null){
                    cls = 'secondary';
                    txt = 'skip';
                }else if(r.ok){
                    cls = 'success';
                    txt = 'ok';
                }else{
                    cls = 'danger';
                    txt = 'fail';
                }
                badge.className = `badge bg-${cls}`;
                badge.textContent = txt;
                li.appendChild(badge);
                li.append(` ${r.step}: ${r.detail}`);
                ul.appendChild(li);
                if(r.hints){
                    const hint = document.createElement('div');
                    hint.className = 'text-muted ms-4';
                    hint.textContent = Array.isArray(r.hints) ? r.hints.join(', ') : r.hints;
                    ul.appendChild(hint);
                }
            });
        }catch(err){
            ul.innerHTML = `<li><span class="badge bg-danger">error</span> ${err}</li>`;
        }
    });
});

const es=new EventSource('/sse/logs/events');
const list=document.getElementById('eventsList');
const eventSel=document.getElementById('eventFilter');
const camSel=document.getElementById('camFilter');
function addOpt(sel,val){if(![...sel.options].some(o=>o.value==String(val))){const opt=document.createElement('option');opt.value=val;opt.textContent=val;sel.appendChild(opt);}}
es.onmessage=e=>{
  const data=JSON.parse(e.data);
  addOpt(eventSel,data.event);
  if(data.camera_id!==undefined){addOpt(camSel,data.camera_id);}
  if(eventSel.value && eventSel.value!==data.event){return;}
  if(camSel.value && String(camSel.value)!==String(data.camera_id)){return;}
  const chip=document.createElement('div');
  let cls='bg-secondary';
  if(data.level==='info'){cls='bg-info text-dark';}
  else if(data.level==='warning'){cls='bg-warning text-dark';}
  else if(data.level==='error'){cls='bg-danger';}
  chip.className=`badge ${cls} event-chip`;
  chip.textContent=`${data.event}${data.camera_id!==undefined?' ['+data.camera_id+']':''}`;
  list.appendChild(chip);
  list.scrollTop=list.scrollHeight;
};
</script>
<script src="{{ url_for('static', path='js/mjpeg_feed.js') }}"></script>
</body>
</html>
